dist: xenial
language: ruby

bundler_args: --without production
cache:
  bundler: true
  directories:
  - node_modules

jobs:
  include:
  - stage: Code analysis
    script: bundle exec rubocop
  - script: bundle exec scss-lint
  - script: bundle exec brakeman

  - stage: Tests

    services:
    - postgresql
    - elasticsearch

    before_script:
    # Add user and database with their previleges for PostgreSQL
    - psql -c "CREATE DATABASE magara_test;" -U postgres
    - psql -c "CREATE USER magara WITH PASSWORD 'magara';" -U postgres
    - psql -c "GRANT ALL PRIVILEGES ON DATABASE magara_test TO magara;" -U postgres
    - psql -c "ALTER USER magara WITH SUPERUSER;" -U postgres
    # Install JavaScript dependencies
    - yarn install
    # Compile assets and setup database
    - bundle exec rails assets:precompile
    - bundle exec rails db:setup
    script: bundle exec rspec

  - stage: Deploy
    script: skip

    deploy:
      - provider: elasticbeanstalk
        access_key_id: $ACCESS_KEY_ID
        secret_access_key: $SECRET_ACCESS_KEY

        bucket_name: $BUCKET_NAME
        # bucket_path: magara-production

        region: us-west-2
        app: magara
        env: magara-production

        skip_cleanup: true
        zip_file: true
        on:
          branch: master
